<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ethereum PoS ‚Äî Consenso Interactivo </title>
<style>
  :root{
    --bg:#0b0f17;
    --panel:#101727;
    --panel-2:#0d1424;
    --text:#eef3ff;
    --muted:#9fb0c6;
    --accent:#62d6ff;
    --accent-2:#8bffb0;
    --accent-3:#f6b26b;
    --danger:#ff6b6b;
    --good:#22d3a6;
    --tip:#ffd166;
    --blob:#5de4c7;
    --grid:#1b2436;
    --card:#0f1626;
    --shadow: 0 14px 40px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1600px 800px at 70% -10%, #17243a 0%, var(--bg) 45%) fixed,
      radial-gradient(1200px 600px at 5% 115%, #15243c 0%, var(--bg) 55%) fixed;
    color:var(--text);
    font: 15.5px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    letter-spacing:.2px;
  }
  header{
    position:sticky; top:0; z-index:20; backdrop-filter: blur(10px);
    background: linear-gradient(180deg, rgba(11,15,23,.96), rgba(11,15,23,.65) 70%, transparent);
    border-bottom:1px solid #1a2235;
  }
  .wrap{max-width:1400px; margin:0 auto; padding:16px 18px;}
  h1{margin:6px 0 2px; font-size:26px; letter-spacing:.3px}
  .subtitle{color:var(--muted); font-size:13.5px}
  .controls{
    display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; align-items:center
  }
  .btn, select, input[type=range]{
    background:linear-gradient(180deg,#1c2741,#121a30);
    color:var(--text); border:1px solid #243252; border-radius:12px; padding:10px 14px; cursor:pointer;
    box-shadow: var(--shadow);
    font-weight:600;
  }
  .btn:hover{filter:brightness(1.08)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:linear-gradient(180deg,#182238,#0f1627)}
  .badge{
    display:inline-flex; align-items:center; gap:10px; padding:7px 12px; border-radius:999px;
    background:#0e1526; border:1px solid #1d2b4a; color:var(--muted)
  }
  .grid{
    display:grid; gap:20px; padding:20px; max-width:1400px; margin:0 auto;
    grid-template-columns: 1.4fr 1.1fr; grid-auto-rows:minmax(340px,auto);
  }
  .panel{
    background:linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid #1a2235; border-radius:18px; box-shadow:var(--shadow); position:relative; overflow:hidden;
    transition: box-shadow .3s ease;
  }
  .panel h2{margin:14px 14px 0; font-size:18px}
  .panel p.desc{margin:6px 14px 12px; color:var(--muted); font-size:14px}
  .legend{display:flex; gap:10px; flex-wrap:wrap; margin:8px 14px 12px}
  .legend .item{display:flex; align-items:center; gap:8px; color:#bfd0e6; font-size:12.8px; background:#0f1730; border:1px solid #203054; padding:5px 10px; border-radius:10px}
  .dot{width:12px; height:12px; border-radius:50%}
  .dot.proposer{background:var(--accent)}
  .dot.attester{background:var(--accent-2)}
  .dot.slash{background:var(--danger)}
  .dot.blob{background:var(--blob)}
  .canvas{padding:10px 14px 14px}
  .note{color:var(--muted); font-size:13px; margin:8px 14px}
  .footer{color:#b9c7de; font-size:13.5px; text-align:center; padding:24px 16px; opacity:.95}
  svg{width:100%; height:100%}
  .monos{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Roboto Mono", "Liberation Mono", monospace}
  .tabs{display:flex; gap:10px; margin:10px 14px 0}
  .tab{padding:8px 12px; border-radius:12px; border:1px solid #233055; cursor:pointer;
       background:linear-gradient(180deg,#151d31,#0f1628); color:#c7d6ec; font-size:13px; font-weight:600}
  .tab.active{background:linear-gradient(180deg,#203055,#162446); color:#fff; box-shadow:0 0 0 2px rgba(98,214,255,.22) inset}
  .hidden{display:none}
  .tip{position:relative; cursor:help}
  .tip:hover::after{
    content:attr(data-tip); position:absolute; left:0; bottom:112%;
    background:#0e1526; color:#d9e6ff; border:1px solid #203055; padding:8px 10px; z-index:50;
    width:320px; border-radius:10px; box-shadow:var(--shadow); font-size:12.8px;
  }
  .bar{height:10px; background:#1a2744; border-radius:99px; overflow:hidden}
  .bar>span{display:block; height:100%; background:linear-gradient(90deg, var(--good), #48e1ff); width:0%; transition: width .4s ease;}
  .glow{ box-shadow: 0 0 0 0 rgba(98,214,255,.55); animation: pulse 2.4s infinite; }
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(98,214,255,.6)}
    70%{box-shadow:0 0 0 22px rgba(98,214,255,0)}
    100%{box-shadow:0 0 0 0 rgba(98,214,255,0)}
  }
  #svgTimeline{min-height:340px} #svgRing{min-height:380px} #svgGhost{min-height:360px}
  #svgFFG{min-height:360px} #svgPBS{min-height:360px} #svgBlobs{min-height:360px}
  
  .presentation-mode { font-size: 1.1em; }
  .presentation-mode .panel h2 { font-size: 22px; }
  .presentation-mode .desc, .presentation-mode .note { font-size: 15px; }
  .presentation-mode h1 { font-size: 30px; }

  .critical-event { animation: highlightPulse 1s 2; }
  @keyframes highlightPulse {
      0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 102, 0.2), var(--shadow); }
      50% { box-shadow: 0 0 28px 8px rgba(255, 215, 102, 0.6), var(--shadow); }
  }

  #event-notifier {
    position: fixed; top: 140px; left: 50%; transform: translateX(-50%);
    background: linear-gradient(180deg, #151d31, #0f1628);
    border: 1px solid var(--accent-3);
    color: var(--accent-3);
    padding: 14px 22px; border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.5);
    z-index: 100; font-size: 16px; font-weight: 600;
    opacity: 0; pointer-events: none;
    transition: opacity .4s ease-in-out, top .4s ease-in-out;
  }
  #event-notifier.show { top: 160px; opacity: 1; }

  @media (max-width:1100px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div id="event-notifier"></div>

  <header>
    <div class="wrap">
      <h1>Ethereum PoS ‚Äî Consenso Interactivo </h1>
      <div class="subtitle">Slots (12s), Epochs (32), LMD-GHOST, Casper FFG, comit√©s (BLS), slashing, inactivity leak, PBS/MEV-Boost y blobs (EIP-4844).</div>
      <div class="controls" role="toolbar" aria-label="Controles de simulaci√≥n">
        <button id="btnStart" class="btn">‚ñ∂Ô∏è Iniciar</button>
        <button id="btnPause" class="btn secondary">‚è∏Ô∏è Pausar</button>
        <button id="btnStep" class="btn">‚è≠Ô∏è Siguiente slot</button>
        <button id="btnEpoch" class="btn secondary">‚è© Siguiente epoch</button>
        <button id="btnReset" class="btn">‚ôªÔ∏è Reset</button>
        <button id="btnPresentation" class="btn secondary" title="Modo Presentaci√≥n">üñºÔ∏è</button>
        <button id="btnBookmark" class="btn secondary" title="A√±adir Marcador">üìå</button>
      </div>
       <div class="controls" style="margin-top: 16px;">
        <span class="badge" aria-live="polite">Slot: <strong id="slotLabel" class="monos">0</strong> / Epoch: <strong id="epochLabel" class="monos">0</strong></span>
        <span class="badge" aria-live="polite">Participaci√≥n: <strong id="participationLabel" class="monos">0%</strong></span>
        <span class="badge" aria-live="polite">Pr√≥ximo Epoch en: <strong id="epochCountdown" class="monos">32</strong> slots</span>
        <span class="badge" aria-live="polite">Salud de Red: <strong id="networkHealth" style="color:var(--good)">Saludable</strong></span>
        <span class="badge">Velocidad:
          <input id="speed" type="range" min="0.25" max="4" step="0.25" value="1" style="width:120px">
          <span id="speedVal" class="monos">1.00√ó</span>
        </span>
       </div>
    </div>
  </header>
  
  <main class="grid" aria-live="polite">
    <section class="panel" id="panel-overview" aria-label="Resumen Beacon Chain">
        <h2>1) Beacon Chain ‚Äî Resumen</h2>
        <p class="desc">Cada <strong>slot (~12s)</strong> tiene un <span class="tip" data-tip="El validador que construye el bloque del slot">proponente</span> y varios <span class="tip" data-tip="Validadores que votan por la cabeza de la cadena (LMD-GHOST) y por checkpoints (Casper FFG)">atestadores</span>. Con ‚â•2/3 del stake, los checkpoints se <em>justifican</em> y <em>finalizan</em>.</p>
        <div class="legend">
          <span class="item"><span class="dot proposer"></span>Proponente</span>
          <span class="item"><span class="dot attester"></span>Atestadores</span>
          <span class="item"><span class="dot slash"></span>Slashing</span>
          <span class="item"><span class="dot blob"></span>Blob (EIP-4844)</span>
        </div>
        <div class="canvas" style="display:grid; grid-template-columns:1.3fr 1fr; gap:14px; min-height:420px">
          <div class="panel" style="min-height:400px" aria-label="Timeline de slots y checkpoints">
            <h2 style="margin:12px 12px 0">Timeline de Slots & Checkpoints</h2>
            <div class="note">Observa justificaci√≥n/finalidad y bloques con <b>blobs</b> (datos L2).</div>
            <svg id="svgTimeline" viewBox="0 0 1200 340" role="img" aria-label="Timeline de la cadena"></svg>
          </div>
          <div class="panel" style="min-height:400px" aria-label="Anillo de validadores">
            <h2 style="margin:12px 12px 0">Anillo de Validadores & Comit√©s</h2>
            <div class="note">Se ilumina el proponente y el comit√© de atestaci√≥n. Arco = agregaci√≥n BLS.</div>
            <svg id="svgRing" viewBox="0 0 500 380"></svg>
          </div>
        </div>
        <div class="note">Participaci√≥n del epoch</div>
        <div class="canvas">
          <div class="bar"><span id="barParticipation"></span></div>
        </div>
      </section>
  
      <section class="panel" id="panel-fc" aria-label="Fork-choice LMD-GHOST">
        <div class="tabs">
          <button class="tab active" data-tab="fc">2) LMD-GHOST</button>
          <button class="tab" data-tab="ffg">3) Casper FFG</button>
          <button class="tab" data-tab="pbs">4) PBS / MEV-Boost</button>
          <button class="tab" data-tab="blobs">5) Blobs (EIP-4844)</button>
        </div>
        <div id="tab-fc" class="tabpane">
          <p class="desc">La cabeza es la rama con mayor peso de atestaciones <em>recientes</em>. Se muestran ramas, pesos y la cabeza actual.</p>
          <div class="canvas" style="min-height:380px"> <svg id="svgGhost" viewBox="0 0 1200 360"></svg> </div>
        </div>
        <div id="tab-ffg" class="tabpane hidden">
          <p class="desc">Cada epoch establece un <b>checkpoint</b>. Con ‚â•2/3 de votos coherentes: <b>justificado</b>; si el siguiente tambi√©n se justifica, el anterior queda <b>finalizado</b>.</p>
          <div class="canvas" style="min-height:380px"> <svg id="svgFFG" viewBox="0 0 1200 360"></svg> </div>
        </div>
        <div id="tab-pbs" class="tabpane hidden">
          <p class="desc">Separaci√≥n proponente-constructor (hoy v√≠a <b>MEV-Boost</b>): <em>builders</em> ‚Üí <em>relays</em> ‚Üí <em>proposer</em>. Si falla, <em>fallback</em> local.</p>
          <div class="canvas" style="min-height:380px"> <svg id="svgPBS" viewBox="0 0 1200 360"></svg> </div>
        </div>
        <div id="tab-blobs" class="tabpane hidden">
          <p class="desc">Los bloques pueden adjuntar <b>blob sidecars</b> (datos baratos para L2). No son transacciones; su disponibilidad se sigue en consenso.</p>
          <div class="canvas" style="min-height:380px"> <svg id="svgBlobs" viewBox="0 0 1200 360"></svg> </div>
        </div>
      </section>
  
      <section class="panel" aria-label="Notas operativas y riesgos">
        <h2>Notas operativas & riesgos</h2>
        <ul class="desc" style="font-size:14.2px">
            <li><b>Weak subjectivity:</b> nodos nuevos arrancan desde un checkpoint reciente de confianza.</li>
            <li><b>Inactivity leak:</b> si no hay finalizaci√≥n prolongada, penalizaciones crecen para empujar a ‚â•2/3 de participaci√≥n.</li>
            <li><b>Slashing:</b> double-vote, surround-vote, o doble propuesta en mismo slot ‚áí expulsi√≥n + penalizaci√≥n correlacionada.</li>
            <li><b>Diversidad de clientes:</b> ejecuci√≥n + consenso (Prysm/Lighthouse/Teku/Nimbus/Lodestar).</li>
        </ul>
      </section>
  </main>

  <div class="footer"> Material elaborado por el profesor <b>Sergio Gevatschnaider</b> </div>

<script>
const $ = sel => document.querySelector(sel);
const svgNS = "http://www.w3.org/2000/svg";
const lerp = (a,b,t)=>a+(b-a)*t;
function prng(seed=1){let s=seed>>>0; return ()=>((s=(1664525*s+1013904223)>>>0)/0x100000000);}
function shuffle(arr, rnd=Math.random){for(let i=arr.length-1;i>0;i--){const j=Math.floor(rnd()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr;}
function svgEl(tag, attrs={}, parent){const el=document.createElementNS(svgNS,tag);for(const k in attrs){el.setAttribute(k,attrs[k]);}parent&&parent.appendChild(el);return el;}

const state = {
  validators: [], totalValidators: 128, slot: 0, epoch: 0, slotsPerEpoch: 32,
  failureRate: 0.05, running:false, speed:1, rng: prng(1337),
  chain: [], tree: {}, headId: "genesis", lastJustified: 0, lastFinalized:-1,
  participationWindow: [], pbs: { relaysUp:true, lastBid:0 },
  manualPause: false,
};

const bookmarks = [];

function initValidators(n){state.validators = Array.from({length:n}, (_,i)=>({id:i, slashed:false, effBalance: 32}));}

function resetSim(){
  const n = 128; 
  state.totalValidators=n; state.slot=0; state.epoch=0;
  state.failureRate=0.05; state.speed=1; state.rng=prng(1337);
  state.chain=[{id:"genesis",slot:-1,epoch:-1,justified:true,finalized:true,blobs:0,proposer:-1,attesters:[],misses:0,bid:0}];
  state.tree={"genesis":{id:"genesis",parent:null,slot:-1,weight:0,children:[]}};
  state.headId="genesis"; state.lastJustified=0; state.lastFinalized=-1;
  state.participationWindow=[]; initValidators(n);
  drawAll(true);
}

function selectProposer(slot){return Math.floor(state.rng()*state.totalValidators);}
function selectCommittee(slot){const size=Math.max(12, Math.floor(state.totalValidators/6)); const ids=Array.from({length:state.totalValidators},(_,i)=>i); shuffle(ids, state.rng); return ids.slice(0,size);}

function nextSlot(){
  const slot = ++state.slot; state.epoch = Math.floor(slot/state.slotsPerEpoch);
  const committee = selectCommittee(slot);
  const attesters=[], misses=[];
  committee.forEach(id=>{if(state.rng() >= state.failureRate) attesters.push(id); else misses.push(id);});
  const participation = committee.length > 0 ? attesters.length/committee.length : 0;
  state.participationWindow.push(participation);
  if(state.participationWindow.length > state.slotsPerEpoch) state.participationWindow.shift();

  let slashed = null; 
  if(state.rng()<0.015){ 
      slashed = committee[Math.floor(state.rng()*committee.length)]; 
      if(slashed!=null){ 
          state.validators[slashed].slashed = true; 
          showNotification(`üö® Validador #${slashed} ha sido penalizado (slashed)!`, 5000, "danger");
          freezeForExplanation(5000);
      }
  }
  const relaysUp = state.rng() > 0.07; state.pbs.relaysUp = relaysUp;
  let bid = 0;
  if(relaysUp){ const b1=0.2+state.rng()*0.8, b2=0.2+state.rng()*1.2, b3=0.2+state.rng()*0.6; bid = Math.max(b1,b2,b3); }
  else { bid = 0.15 + state.rng()*0.25; }
  state.pbs.lastBid = bid;
  
  const blobs = (state.rng()<0.4)?(1+Math.floor(state.rng()*4)):0;

  const blockId = `b${slot}`;
  const node = {id:blockId, parent:state.headId, slot, weight:0, children:[]};
  state.tree[blockId] = node; state.tree[state.headId].children.push(node);
  let p=node; while(p){p.weight += attesters.length; p=p.parent?state.tree[p.parent]:null;}

  state.headId = lmdGhost("genesis");

  let justified=false, finalized=false;
  if(slot>0 && slot%state.slotsPerEpoch === 0){
    const avgPart = state.participationWindow.reduce((a,b)=>a+b,0)/state.participationWindow.length||0;
    if(avgPart>=(2/3)){
      justified = true; state.lastJustified = state.epoch;
      if(state.lastFinalized < state.lastJustified - 1){ 
        state.lastFinalized = state.lastJustified - 1; finalized = true;
        showNotification(`‚úÖ Epoch ${state.lastFinalized} Finalizado! La cadena es irreversible.`, 5000);
        freezeForExplanation(5000);
        $("#panel-fc").classList.add("critical-event");
        setTimeout(() => $("#panel-fc").classList.remove("critical-event"), 2000);
      }
    }
  }
  state.chain.push({id:blockId, slot, epoch:state.epoch, proposer:selectProposer(slot), attesters, misses: misses.length, slashed, blobs, justified, finalized, bid});
}

function lmdGhost(rootId){
    let cur=state.tree[rootId];
    while(cur.children&&cur.children.length){let best=cur.children[0];for(let i=1;i<cur.children.length;i++){if(subtreeWeight(cur.children[i])>subtreeWeight(best)){best=cur.children[i];}}cur=best;}
    return cur.id;
}
function subtreeWeight(node){let sum=node.weight;for(const c of node.children)sum+=subtreeWeight(c);return sum;}

function drawAll(full=false){const p=state.participationWindow.length>0?state.participationWindow[state.participationWindow.length-1]:0;drawTimeline(full);drawRing();drawGhost();drawFFG();drawPBS();drawBlobs();updateLabels(p);}
function updateUI(p=0){drawTimeline();drawRing();drawGhost();drawFFG();drawPBS();drawBlobs();updateLabels(p);}

function updateLabels(participation){
  $("#slotLabel").textContent = state.slot;
  $("#epochLabel").textContent = state.epoch;
  const avg = state.participationWindow.reduce((a,b)=>a+b,0)/state.participationWindow.length || 0;
  $("#participationLabel").textContent = (avg*100).toFixed(0)+"%";
  $("#barParticipation").style.width = (avg*100).toFixed(1)+"%";
  
  const slotsUntilNextEpoch = state.slotsPerEpoch - (state.slot % state.slotsPerEpoch);
  $("#epochCountdown").textContent = `${slotsUntilNextEpoch} slots`;
  
  const healthEl = $("#networkHealth");
  if (avg >= 2/3) {
      healthEl.textContent = "Saludable";
      healthEl.style.color = "var(--good)";
  } else if (state.slot > state.slotsPerEpoch) { // Evita el estado "En Riesgo" al inicio
      healthEl.textContent = "En Riesgo";
      healthEl.style.color = "var(--tip)";
  }
}

// --- FUNCIONES DE DIBUJO RESTAURADAS ---
function drawTimeline(full=false){const svg=$("#svgTimeline");if(!svg)return;svg.innerHTML="";const W=1200,H=340,m=24,rY=H/2;svgEl("line",{x1:m,y1:rY,x2:W-m,y2:rY,stroke:"#24365e","stroke-width":3},svg);const last=state.chain.slice(-80);const xS=(i)=>lerp(m,W-m,i/Math.max(1,last.length-1));last.forEach((b,i)=>{const x=xS(i);if(i>0)svgEl("line",{x1:xS(i-1),y1:rY,x2:x,y2:rY,stroke:"#2a3a60","stroke-width":2},svg);const c=(b.id===state.headId)?"#62d6ff":"#4d6aa3";const g=svgEl("g",{},svg);const r=svgEl("rect",{x:x-10,y:rY-14,width:20,height:28,rx:5,fill:c,stroke:"#98bfff","stroke-width":(b.id===state.headId?2:1),opacity:0.95},g);if(b.blobs>0){for(let k=0;k<b.blobs;k++){svgEl("circle",{cx:x-14-k*8,cy:rY-26-k*3,r:4.5,fill:"url(#blobGrad)"},g);}}if(b.justified){svgEl("circle",{cx:x,cy:rY+24,r:5,fill:"#8bffb0"},g);svgEl("text",{x:x,y:rY+44,"text-anchor":"middle",fill:"#bdebd1","font-size":11.2},g).textContent="just.";}if(b.finalized){svgEl("circle",{cx:x,cy:rY+24,r:7,fill:"#22d3a6"},g);svgEl("text",{x:x,y:rY+44,"text-anchor":"middle",fill:"#bdebd1","font-size":11.2,"font-weight":"700"},g).textContent="final";}r.addEventListener("mouseenter",()=>{r.setAttribute("title",`Slot ${b.slot} | Proposer: ${b.proposer}\nAttesters: ${b.attesters.length} | Blobs: ${b.blobs}`)})});const defs=svgEl("defs",{},svg);const blobGrad=svgEl("linearGradient",{id:"blobGrad",x1:"0%",x2:"100%"},defs);svgEl("stop",{offset:"0%","stop-color":"#5de4c7"},blobGrad);svgEl("stop",{offset:"100%","stop-color":"#21b6e3"},blobGrad);}
function drawRing(){const svg=$("#svgRing");if(!svg)return;svg.innerHTML="";const W=500,H=380,cx=W/2,cy=200,R=120;const proposer=state.chain[state.chain.length-1]?.proposer??-1;const committee=selectCommittee(state.slot);svgEl("circle",{cx,cy,r:R+28,fill:"none",stroke:"#22335a","stroke-dasharray":"4 8","stroke-width":1.5},svg);state.validators.forEach((v,idx)=>{const ang=(idx/state.validators.length)*Math.PI*2-Math.PI/2;const x=cx+Math.cos(ang)*R,y=cy+Math.sin(ang)*R;const isProp=proposer===v.id;const inCommittee=committee.includes(v.id);const dot=svgEl("circle",{cx:x,cy:y,r:isProp?7:5,fill:v.slashed?"#ff6b6b":isProp?"#62d6ff":inCommittee?"#8bffb0":"#4b6aa8",stroke:v.slashed?"#7a1b1b":"#223b5f","stroke-width":1.2},svg);if(isProp)dot.classList.add("glow");if(isProp){svgEl("text",{x:x,y:y-12,"text-anchor":"middle",fill:"#9bdfff","font-size":11.5},svg).textContent="proposer";}});if(committee.length>0){const sorted=[...committee].sort((a,b)=>a-b);const sA=(sorted[0]/state.validators.length)*Math.PI*2-Math.PI/2;const eA=(sorted[sorted.length-1]/state.validators.length)*Math.PI*2-Math.PI/2;const x1=cx+Math.cos(sA)*(R+22),y1=cy+Math.sin(sA)*(R+22);const x2=cx+Math.cos(eA)*(R+22),y2=cy+Math.sin(eA)*(R+22);let diff=eA-sA;if(diff<0)diff+=Math.PI*2;const large=diff>Math.PI?1:0;svgEl("path",{d:`M ${x1} ${y1} A ${R+22} ${R+22} 0 ${large} 1 ${x2} ${y2}`,stroke:"#8bffb0","stroke-width":2.4,fill:"none","stroke-dasharray":"5 3"},svg);}svgEl("text",{x:cx,y:30,"text-anchor":"middle",fill:"#cfe2ff","font-size":13.2,"font-weight":"700"},svg).textContent=`Validadores activos: ${state.validators.length}`;}
function drawGhost(){const svg=$("#svgGhost");if(!svg)return;svg.innerHTML="";const W=1200,H=360,margin=34;const nodes=Object.values(state.tree);const bySlot={};nodes.forEach(n=>{const s=Math.max(0,n.slot);(bySlot[s]??=[]).push(n);});const maxSlot=Math.max(...Object.keys(bySlot).map(x=>+x),10);const pos={};for(let s=-1;s<=maxSlot;s++){const row=bySlot[s]||[];row.forEach((n,i)=>{pos[n.id]={x:lerp(margin,W-margin,(s+1)/Math.max(1,maxSlot+1)),y:lerp(60,H-24,(i+1)/(row.length+1))};});}if(!pos['genesis']){pos['genesis']={x:margin,y:H/2};}nodes.forEach(n=>{if(n.parent&&pos[n.parent]&&pos[n.id]){const a=pos[n.parent],b=pos[n.id];svgEl("path",{d:`M ${a.x} ${a.y} C ${lerp(a.x,b.x,.4)} ${a.y}, ${lerp(a.x,b.x,.6)} ${b.y}, ${b.x} ${b.y}`,stroke:"#2a4576","stroke-width":2,fill:"none"},svg);}});nodes.forEach(n=>{if(n.id==="genesis")return;const p=pos[n.id];if(!p)return;const isHead=n.id===state.headId;const r=isHead?8.5:6.2;const c=isHead?"#62d6ff":"#4c6aa1";svgEl("circle",{cx:p.x,cy:p.y,r,fill:c,stroke:"#9dc8ff","stroke-width":isHead?2:1},svg);svgEl("text",{x:p.x+10,y:p.y+4,fill:"#c9dbf6","font-size":12},svg).textContent=`w=${n.weight}`;});svgEl("text",{x:margin,y:24,fill:"#cfe2ff","font-size":13.2},svg).textContent="LMD-GHOST ‚Äî Ramas y pesos recientes. Cabeza = rama con mayor peso descendente.";}
function drawFFG(){const svg=$("#svgFFG");if(!svg)return;svg.innerHTML="";const W=1200,H=360,m=28,Y=H/2;svgEl("line",{x1:m,y1:Y,x2:W-m,y2:Y,stroke:"#243a66","stroke-width":3},svg);const epochs={};for(const b of state.chain){if(b.epoch<0)continue;(epochs[b.epoch]??=[]).push(b);}const keys=Object.keys(epochs).map(x=>+x);if(keys.length===0)return;const minEpoch=Math.max(0,keys[0]);const maxEpoch=Math.max(...keys,minEpoch);const xOf=e=>lerp(m,W-m,(e-minEpoch)/Math.max(1,maxEpoch-minEpoch||1));keys.forEach(e=>{const x=xOf(e),group=epochs[e];const avgPart=group.reduce((a,b)=>a+(b.attesters.length/(b.attesters.length+b.misses||1)),0)/group.length;svgEl("rect",{x:x-7,y:Y-28,width:14,height:56,rx:3,fill:avgPart>=2/3?"#26cfa5":"#3a5288",opacity:.92},svg);svgEl("text",{x:x,y:Y-36,"text-anchor":"middle",fill:"#cde9ff","font-size":12},svg).textContent=`epoch ${e}`;let label="";if(e===state.lastFinalized)label="finalizado";else if(e===state.lastJustified)label="justificado";if(label){svgEl("text",{x:x,y:Y+42,"text-anchor":"middle",fill:"#9bf0cf","font-size":12.5,"font-weight":"700"},svg).textContent=label;}});svgEl("text",{x:m,y:26,fill:"#cfe2ff","font-size":13.2},svg).textContent="Casper FFG ‚Äî checkpoints por epoch, estado de justificaci√≥n/finalidad (‚â•2/3).";}
function drawPBS(){const svg=$("#svgPBS");if(!svg)return;svg.innerHTML="";const W=1200,H=360;const cols={builders:180,relays:600,proposer:980};svgEl("text",{x:cols.builders,y:30,"text-anchor":"middle",fill:"#cfe2ff","font-size":14,"font-weight":"700"},svg).textContent="Builders";svgEl("text",{x:cols.relays,y:30,"text-anchor":"middle",fill:"#cfe2ff","font-size":14,"font-weight":"700"},svg).textContent="Relays";svgEl("text",{x:cols.proposer,y:30,"text-anchor":"middle",fill:"#cfe2ff","font-size":14,"font-weight":"700"},svg).textContent="Proposer";for(let i=0;i<3;i++){const y=84+i*56;svgEl("rect",{x:cols.builders-52,y:y-18,width:104,height:36,rx:10,fill:"#172544",stroke:"#29426f","stroke-width":1.4},svg);svgEl("text",{x:cols.builders,y:y+4,"text-anchor":"middle",fill:"#9fc1ff","font-size":12.8},svg).textContent=`builder ${i+1}`;const rY=110+(i%2)*92;svgEl("path",{d:`M ${cols.builders+52} ${y} C 320 ${y}, 460 ${rY}, ${cols.relays-60} ${rY}`,stroke:"#2fb7f0","stroke-width":2.2,fill:"none","marker-end":"url(#arrowXL)"},svg);}const relaysUp=state.pbs.relaysUp;for(let i=0;i<2;i++){const y=110+i*92;svgEl("rect",{x:cols.relays-60,y:y-20,width:120,height:40,rx:11,fill:relaysUp?"#173a2f":"#3a2a2a",stroke:relaysUp?"#2aa57d":"#8b3f3f","stroke-width":1.6},svg);svgEl("text",{x:cols.relays,y:y+5,"text-anchor":"middle",fill:relaysUp?"#8bffb0":"#ff9f9f","font-size":13.2},svg).textContent=relaysUp?"relay ‚úì":"relay ‚úï";svgEl("path",{d:`M ${cols.relays+60} ${y} C 720 ${y}, 860 ${y}, ${cols.proposer-56} ${y}`,stroke:relaysUp?"#2fd3a8":"#ff8b8b","stroke-width":2.6,fill:"none","marker-end":"url(#arrowXL)"},svg);}const yP=190;svgEl("rect",{x:cols.proposer-76,y:yP-28,width:152,height:56,rx:12,fill:"#172544",stroke:"#29426f","stroke-width":1.6},svg);svgEl("text",{x:cols.proposer,y:yP-6,"text-anchor":"middle",fill:"#cfe2ff","font-size":14},svg).textContent="proposer";svgEl("text",{x:cols.proposer,y:yP+16,"text-anchor":"middle",fill:"#ffd166","font-size":13},svg).textContent=`bid: ${state.pbs.lastBid.toFixed(2)} ETH`;const defs=svgEl("defs",{},svg);const marker=svgEl("marker",{id:"arrowXL",viewBox:"0 0 10 10",refX:"9",refY:"5",markerWidth:"7",markerHeight:"7",orient:"auto-start-reverse"},defs);svgEl("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:"#2fb7f0"},marker);svgEl("text",{x:24,y:H-14,fill:"#cfe2ff","font-size":13},svg).textContent="Si relays fallan ‚Üí fallback de construcci√≥n local (bid menor).";}
function drawBlobs(){const svg=$("#svgBlobs");if(!svg)return;svg.innerHTML="";const W=1200,H=360,m=28;svgEl("text",{x:m,y:28,fill:"#cfe2ff","font-size":14},svg).textContent="Bloques con blobs adjuntos (datos L2 baratos)";const data=state.chain.slice(-48);const cols=16,cellW=(W-2*m)/cols,cellH=54;data.forEach((b,i)=>{const r=Math.floor(i/cols),c=i%cols;const x=m+c*cellW,y=44+r*(cellH+12);svgEl("rect",{x,y,width:cellW-10,height:cellH,rx:10,fill:"#1a2a48",stroke:"#28406b","stroke-width":1.4},svg);svgEl("text",{x:x+10,y:y+18,fill:"#9fc1ff","font-size":12.5},svg).textContent=`slot ${b.slot}`;svgEl("text",{x:x+10,y:y+36,fill:"#cfe2ff","font-size":13},svg).textContent=`blobs: ${b.blobs}`;for(let k=0;k<b.blobs;k++){svgEl("circle",{cx:x+cellW-26-k*12,cy:y+28,r:6,fill:"url(#blobGrad2)",stroke:"#164a42"},svg);}});const defs=svgEl("defs",{},svg);const grad=svgEl("linearGradient",{id:"blobGrad2",x1:"0%",x2:"100%"},defs);svgEl("stop",{offset:"0%","stop-color":"#5de4c7"},grad);svgEl("stop",{offset:"100%","stop-color":"#8bd9ff"},grad);}

document.querySelectorAll(".tab").forEach(btn=>{btn.addEventListener("click",()=>{document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));document.querySelectorAll(".tabpane").forEach(p=>p.classList.add("hidden"));btn.classList.add("active");$("#tab-"+btn.dataset.tab).classList.remove("hidden");});});

function togglePresentationMode() { document.body.classList.toggle('presentation-mode'); }

function addBookmark() {
    const description = prompt("A√±ade una descripci√≥n para este momento:", `Slot ${state.slot}`);
    if (description) {
        bookmarks.push({slot: state.slot, description});
        console.log("Marcadores actuales:", bookmarks);
        showNotification(`üìå Marcador a√±adido en slot ${state.slot}`, 2000);
    }
}

function freezeForExplanation(duration = 5000) {
    if (state.running) {
        pause();
        state.manualPause = false; // This is an auto-pause
        setTimeout(() => {
            if (!state.manualPause) { // Only restart if user hasn't manually paused in the meantime
                start();
            }
        }, duration);
    }
}

function showNotification(message, duration = 3000, type = 'info') {
    const notifier = $("#event-notifier");
    notifier.textContent = message;
    notifier.style.borderColor = type === 'danger' ? 'var(--danger)' : 'var(--accent-3)';
    notifier.style.color = type === 'danger' ? 'var(--danger)' : 'var(--accent-3)';
    notifier.classList.add('show');
    setTimeout(() => notifier.classList.remove('show'), duration - 400);
}

let ticker=null;
function tick(){ nextSlot(); updateUI(); }
function start(){if(ticker)return;state.running=true;state.manualPause=false;const step=()=>{if(!state.running){clearTimeout(ticker);ticker=null;return;}tick();ticker=setTimeout(step, 500/state.speed);};step();}
function pause(){state.running=false;state.manualPause=true;}
function step(){pause();tick();}
function nextEpoch(){pause();for(let i=0;i<state.slotsPerEpoch;i++)tick();}
function setSpeed(v){state.speed=parseFloat(v);$("#speedVal").textContent=state.speed.toFixed(2)+"√ó";}

document.addEventListener('DOMContentLoaded', () => {
    $("#btnStart").addEventListener("click", start);
    $("#btnPause").addEventListener("click", pause);
    $("#btnStep").addEventListener("click", step);
    $("#btnEpoch").addEventListener("click", nextEpoch);
    $("#btnReset").addEventListener("click", ()=>{pause();resetSim();});
    $("#speed").addEventListener("input", e=>setSpeed(e.target.value));
    $("#btnPresentation").addEventListener("click", togglePresentationMode);
    $("#btnBookmark").addEventListener("click", addBookmark);

    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            state.running ? pause() : start();
        }
    });

    resetSim();
});
</script>
</body>
</html>